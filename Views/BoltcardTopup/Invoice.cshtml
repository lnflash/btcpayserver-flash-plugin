@using BTCPayServer.Plugins.Flash.Models
@model BoltcardInvoiceViewModel
@{
    ViewData["Title"] = "Boltcard Topup Invoice";
    Layout = "_Layout";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Scan with Flash Mobile Wallet</h3>
                </div>
                <div class="card-body text-center">
                    <h4 class="mb-3">@Model.Amount satoshis</h4>
                    <p class="text-muted mb-4">@Model.Description</p>
                    
                    <div class="mb-4">
                        <div id="qrcode" class="d-inline-block p-3 bg-white border rounded"></div>
                    </div>
                    
                    <div class="mb-3">
                        <button id="copy-invoice" class="btn btn-outline-primary" onclick="copyInvoice()">
                            <i class="fa fa-copy"></i> Copy Invoice
                        </button>
                        <button id="check-status" class="btn btn-outline-secondary ml-2" onclick="checkStatus()">
                            <i class="fa fa-refresh"></i> Check Status
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <a id="open-flash" href="lightning:@Model.PaymentRequest" class="btn btn-primary">
                            Open in Flash Wallet
                        </a>
                    </div>
                    
                    <div id="invoice-status" class="alert @(Model.Status == "Paid" ? "alert-success" : "alert-info")">
                        <strong>Status:</strong> <span id="status-text">@Model.Status</span>
                    </div>
                    
                    <div class="small text-muted">
                        Invoice expires in <span id="expiry-time">@Model.ExpirySeconds</span> seconds
                    </div>
                    
                    <textarea id="bolt11-text" class="d-none">@Model.PaymentRequest</textarea>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/vendor/qrcode/qrcode.min.js"></script>
    <script>
        // Generate QR code
        var qrcode = new QRCode(document.getElementById("qrcode"), {
            text: "@Model.PaymentRequest",
            width: 240,
            height: 240,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // Copy invoice to clipboard
        function copyInvoice() {
            const bolt11El = document.getElementById("bolt11-text");
            bolt11El.classList.remove("d-none");
            bolt11El.select();
            document.execCommand("copy");
            bolt11El.classList.add("d-none");
            
            const copyBtn = document.getElementById("copy-invoice");
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fa fa-check"></i> Copied!';
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
            }, 2000);
        }
        
        // Check invoice status
        function checkStatus() {
            window.location.reload();
        }
        
        // Countdown timer
        let secondsRemaining = @Model.ExpirySeconds;
        const expiryEl = document.getElementById("expiry-time");
        
        function updateTimer() {
            if (secondsRemaining <= 0) {
                expiryEl.textContent = "Expired";
                return;
            }
            
            secondsRemaining--;
            expiryEl.textContent = secondsRemaining;
            setTimeout(updateTimer, 1000);
        }
        
        // Start countdown
        updateTimer();
        
        // Auto-refresh status every 5 seconds
        const autoRefresh = setInterval(() => {
            const statusText = document.getElementById("status-text").textContent;
            if (statusText === "Paid" || statusText === "Complete") {
                clearInterval(autoRefresh);
                window.location.href = window.location.pathname.replace("/invoice/", "/success/");
            } else {
                checkStatus();
            }
        }, 5000);
    </script>
}